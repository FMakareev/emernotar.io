<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server/createCertificatPDF.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server/createCertificatPDF.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {certificateTemplate} from './certificate_template';
import fs from 'fs';
import fsExtra from 'fs-extra'

const phantomPdf = require('phantom-html2pdf');
const puppeteer = require('puppeteer');

// import HtmlToPdf from 'html-pdf';
// const convertHTMLToPDF = require("pdf-puppeteer");

import path from 'path';


export const createCertificat = async (req,response) => {
    try {
        const {params: {hash}} = req;
        console.log('__dirname:',__dirname);
        /**
         * @description path to the certificate store
         * */
        const certificates_dir = process.cwd() + '/public/assets/certificates/';
        const fileName = encodeURIComponent(hash).substring(0,30);
        console.log('certificates_dir:',certificates_dir);

        /**
         * @description path to the certificate
         * */
        const certificat_path = `${certificates_dir}${fileName}.pdf`;
        console.log('certificat_path:',certificat_path);

        /**
         * @description check for a directory for storing certificates
         * */
        if (!fs.existsSync(certificates_dir)) {
            try {
                fs.mkdirSync(certificates_dir,(err,folder) => {
                    if (err) {
                        console.log('line 31. mkdirSync err: ',err);
                    }
                    console.log('line 31. mkdirSync folder:',folder);
                });
            } catch (error) {
                console.log('line 35. error: ',error);
            }
        } else {
            fsExtra.emptyDir(certificates_dir)
                .then(() => {
                    console.log('SUCCESS EMPTY DIR!')
                })
                .catch(err => {
                    console.error(`ERROR EMPTY DIR: certificates_dir :`,err)
                })
        }

        /**
         * @description Verifying the presence of a certificate with a transmitted hash
         */
        // if (!fs.existsSync(certificat_path)) {

        /**
         *    Usage
         *    @param html - This is the html to be converted to a pdf
         *    @param callback - Do something with the PDF
         *    @param [options] - Optional parameter to pass in Puppeteer PDF options
         */
        const result = await createPDF(hash,fileName);
        console.log('result',result);

        
        /**
         * @description Read the certificate file and send in response to the user
         */

        fs.readFile(certificat_path,function (err,data) {
            if (err) throw err;
            response.contentType("application/pdf");
            // res.send('');
            response.send(data);
        });
    } catch (error) {
        console.log('error: ',error);
        response.status(502);
        response.send(error);
        response.end();
    }
    // response.status(200);
    // /** @description http://expressjs.com/en/4x/api.html#res.send */
    // response.send('createCertificat');
    // /** @description http://expressjs.com/en/4x/api.html#res.end */
    // response.end();


}

const createPDF = async (hash,fileName) => {
    const html = await certificateTemplate(hash);
    // console.log('html: ',html);


    const options = {
        html: html,
        "paperSize": {
            format: 'A4', 
            orientation: 'landscape', 
            border: '0',
            // delay: 10000,
        }
    };
    await new Promise((response, resolve) => {

        phantomPdf.convert(options,function (err,result) {

            /* Using a buffer and callback */
            result.toBuffer(function (returnedBuffer) {
            });

            /* Using the file writer and callback */
            result.toFile(`${process.cwd()}/public/assets/certificates/${fileName}.pdf`,function (event) {
                console.log('phantomPdf finish.',event);
                response(event)
            });
        });
    })
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="LanguageSwitcher.html">LanguageSwitcher</a></li><li><a href="Verify.VerifyModal.html">VerifyModal</a></li><li><a href="Verify.VerifyPage.html">VerifyPage</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addFlexMS">addFlexMS</a></li><li><a href="global.html#btnStyles">btnStyles</a></li><li><a href="global.html#createRoutes">createRoutes</a></li><li><a href="global.html#createStyleRenderer">createStyleRenderer</a></li><li><a href="global.html#currentLanguage">currentLanguage</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#handleSubmit">handleSubmit</a></li><li><a href="global.html#has">has</a></li><li><a href="global.html#hash">hash</a></li><li><a href="global.html#initLocalize">initLocalize</a></li><li><a href="global.html#instruction">instruction</a></li><li><a href="global.html#language">language</a></li><li><a href="global.html#languages">languages</a></li><li><a href="global.html#onModalToggle">onModalToggle</a></li><li><a href="global.html#open">open</a></li><li><a href="global.html#pristine">pristine</a></li><li><a href="global.html#rehydrateState">rehydrateState</a></li><li><a href="global.html#renderer">renderer</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#ROOT">ROOT</a></li><li><a href="global.html#setActiveLanguage">setActiveLanguage</a></li><li><a href="global.html#staticContext">staticContext</a></li><li><a href="global.html#styles">styles</a></li><li><a href="global.html#submitting">submitting</a></li><li><a href="global.html#translate">translate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jun 01 2018 13:15:57 GMT+0300 (MSK)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
